<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCH Dasboard</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <!-- Google Fonts for Noto Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Custom font for body */
        body {
            font-family: 'Noto Sans', sans-serif; /* Changed font to Noto Sans, with sans-serif as fallback */
        }
        /* Ensure the body and html take full height to allow children to expand */
        html, body {
            height: 100%;
            margin: 0; /* Ensure no default body margin */
            overflow-x: hidden; /* Prevent horizontal scroll when sidebar slides out */
        }
        /* Custom styles for sidebar animation */
        #sidebar {
            /* Apply transitions to transform, width, and padding for smooth collapsing/expanding */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out;
        }

        /* Custom styles for main content area margin transition when sidebar toggles on desktop */
        #data-entry-area {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Mobile specific styles (sidebar slides from left) */
        @media (max-width: 767px) { /* Tailwind's md breakpoint is 768px */
            #sidebar {
                transform: translateX(-100%); /* Start off-screen */
                position: fixed; /* Overlay on top of content */
                height: 100%; /* Take full height on mobile */
                z-index: 50; /* Ensure it's above other content */
                width: 75%; /* Adjust width for mobile sidebar */
                top: 0;
                left: 0;
            }
            body.sidebar-open #sidebar {
                transform: translateX(0); /* Slide in when open */
            }
            /* Show overlay when sidebar is open on mobile */
            body.sidebar-open #overlay {
                display: block;
            }
        }

        /* Desktop specific styles (sidebar width collapses/expands) */
        @media (min-width: 768px) {
            #sidebar {
                width: 16rem; /* Default open width for desktop (equivalent to w-64) */
                position: relative; /* Override fixed positioning from mobile */
                height: auto; /* Override height: 100% from mobile */
                z-index: auto; /* Override z-index from mobile */
                top: auto; /* Override top from mobile */
                left: auto; /* Override left from mobile */
            }
            /* When sidebar-open class is NOT present on desktop, collapse sidebar */
            body:not(.sidebar-open) #sidebar {
                width: 0;
                padding-left: 0;
                padding-right: 0;
                margin-right: 0;
                overflow: hidden; /* Hide content when collapsed */
            }
            /* When sidebar is open on desktop, apply margin to data entry area */
            body.sidebar-open #data-entry-area {
                margin-left: 1rem; /* Equivalent to md:ml-4 */
            }
            /* When sidebar is closed on desktop, remove margin from data entry area */
            body:not(.sidebar-open) #data-entry-area {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

    <!-- Header -->
    <header class="bg-black text-white p-4 flex items-center justify-between shadow-md">
        <!-- Hamburger menu button now inside the header -->
        <button id="menu-button" class="p-2 rounded-md bg-indigo-600 text-white shadow-md">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        <p class="text-2xl font-semibold">NCH Dashboard</p>
        <div></div> <!-- Placeholder for any potential right-aligned header content -->
    </header>

    <!-- Overlay for mobile when sidebar is open - acts as a clickable backdrop -->
    <div id="overlay" class="hidden fixed inset-0 bg-black opacity-50 z-40 md:hidden"></div>

    <!-- Main layout container (flex for columns) -->
    <div class="w-full flex-grow flex p-3">
        <!-- Left panel (Sidebar) -->
        <div id="sidebar" class="bg-gray-200 shadow-lg rounded-lg p-4 flex-shrink-0 h-full">
            <ul class="mt-4 space-y-2">
                <li><a href="old.html" class="block p-2 rounded-md hover:bg-gray-300">Dashboard</a></li>
                <li><a href="gaps.html" class="block p-2 rounded-md hover:bg-gray-300">Care Gap Closure</a></li>
                <li><a href="entry.html" class="block p-2 rounded-md hover:bg-gray-300">Patient Access Goals</a></li>
                <li><a href="entry.html" class="block p-2 rounded-md hover:bg-gray-300">Risk Score</a></li>
                <li><a href="entry.html" class="block p-2 rounded-md hover:bg-gray-300">Other</a></li>
            </ul>
        </div>

        <!-- Data Entry and Graph Area (now a 2x1 grid/flex column) -->
        <div id="data-entry-area" class="flex flex-col flex-grow ml-2 space-y-2.5">

            <!-- Top div: Add New Data Point -->
            <div class="bg-white shadow-lg rounded-lg p-4 flex-grow-0">
                <!-- <h2 class="text-xl font-semibold text-gray-800 mb-4">Add New Data Point</h2> -->
                <div class="space-y-4">
                    <div>
                        <label for="xAxisInput" class="block text-sm font-medium text-gray-700"><strong>Percent Closure Amount</strong></label>
                        <input type="float" id="xAxisInput" name="xAxisInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Enter the percentage of care gaps closed">
                    </div>
                    <div>
                        <label for="yAxisInput" class="block text-sm font-medium text-gray-700"><strong>Date</strong></label>
                        <input type="date" id="yAxisInput" name="yAxisInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="MM/DD/YYYY">
                    </div>
                    <div>
                        <label for="insuranceSelect" class="block text-sm font-medium text-gray-700"><strong>Insurance</strong></label>
                        <select id="insuranceSelect" name="insuranceSelect" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="">Select an insurance company</option>
                        <option value="MyBlue">MyBlue</option>
                        <option value="BCBS APO">BCBS APO</option>
                        <option value="Optum">Optum</option>
                        <option value="WellMed">WellMed</option>
                        </select>
                    </div>
                <button id="addEntryButton" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Add Entry
                </button>
                </div>
            </div>

            <!-- Bottom div: Graph Area (now contains a 1x2 layout, responsive stacking) -->
            <div class="bg-white-200 p-4 rounded-lg shadow-md flex-grow flex flex-col space-y-4 md:flex-row md:space-x-4 md:space-y-0">
                <!-- Left section (3/4 width on desktop, full width on mobile) -->
                <div class="bg-whitr-100 p-2 rounded-lg flex items-center justify-center w-full md:w-3/4 flex-grow">
                    <canvas id="gapClosureChart" class="w-full h-full"></canvas>
                </div>
                <!-- Right section (1/4 width on desktop, full width on mobile) -->
                <div class="bg-blue-100 p-1 rounded-lg flex items-center justify-center w-full md:w-1/4 flex-grow">
                    <p class="text-lg font-semibold text-blue-800">Other Statistics (1:3)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for sidebar toggle functionality -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menu-button');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const body = document.body;
            const dataEntryArea = document.getElementById('data-entry-area');

            // Input fields and button for data entry
            const xAxisInput = document.getElementById('xAxisInput');
            const yAxisInput = document.getElementById('yAxisInput');
            const addEntryButton = document.getElementById('addEntryButton');

            // Function to open sidebar
            function openSidebar() {
                body.classList.add('sidebar-open');
            }

            // Function to close sidebar
            function closeSidebar() {
                body.classList.remove('sidebar-open');
            }

            // Set initial sidebar state based on screen size
            if (window.innerWidth >= 768) {
                openSidebar(); // Sidebar open by default on desktop
            } else {
                closeSidebar(); // Sidebar closed by default on mobile
            }

            // Toggle sidebar on menu button click
            menuButton.addEventListener('click', function() {
                if (body.classList.contains('sidebar-open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });

            // Close sidebar when clicking outside (on overlay) - primarily for mobile
            overlay.addEventListener('click', closeSidebar);

            // Close sidebar when clicking any link inside
            sidebar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', closeSidebar);
            });

            // Handle resize events to maintain correct sidebar state and layout
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    // If resizing to desktop, ensure sidebar is open if it wasn't already
                    if (!body.classList.contains('sidebar-open')) {
                         openSidebar();
                    }
                    // Adjust data entry area margin on desktop
                    if (body.classList.contains('sidebar-open')) {
                        dataEntryArea.style.marginLeft = '1rem';
                    } else {
                        dataEntryArea.style.marginLeft = '0';
                    }
                } else {
                    // If resizing to mobile, ensure sidebar is closed
                    closeSidebar();
                    dataEntryArea.style.marginLeft = '0'; // Ensure no margin on mobile
                }
            });

            // Add event listener for the Add Entry button
            addEntryButton.addEventListener('click', function() {
                const xAxisValue = xAxisInput.value.trim();
                const yAxisValue = yAxisInput.value.trim();

                if (xAxisValue && yAxisValue) {
                    console.log(`New Entry Added - X: ${xAxisValue}, Y: ${yAxisValue}`);

                    // Clear input fields
                    xAxisInput.value = '';
                    yAxisInput.value = '';
                } else {
                    console.log('Please enter values for both X and Y axes.');
                }
            });
        });
    </script>

    <!-- Supabase and Chart.js Integration Script -->
    <script type="module">

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://mzbnudzzilqcvwwwfrsw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16Ym51ZHp6aWxxY3Z3d3dmcnN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMzQzNTUsImV4cCI6MjA3MTgxMDM1NX0.FmEhkmCkiOI3C5sG0_N2eLpdA-YhUdjF6edtto-Tu_I';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let chartInstance = null;
    

  async function renderSupabaseChart(canvasId, tableName, chartType, xColumn, yColumn, groupColumn = null) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas element with ID "${canvasId}" not found.`);
      return;
    }

    const ctx = canvas.getContext('2d');

    // Dynamically set the columns to fetch based on whether a groupColumn is provided
    const selectQuery = groupColumn ? `${xColumn}, ${yColumn}, ${groupColumn}` : `${xColumn}, ${yColumn}`;

    // Fetch data from the specified Supabase table
    const { data: records, error } = await supabase
      .from(tableName)
      .select(selectQuery)
      .order(xColumn, { ascending: true });

    //Error handling and no data case
    if (error) {
      console.error('Error fetching data:', error.message);
      return;
    }
    if (!records || records.length === 0) {
      console.warn('No data found for the specified table.');
      if (chartInstance) {
        chartInstance.destroy();
      }
      return;
    }

    let labels;
    let datasets;

    // Logic for a multi-line chart (if a groupColumn is provided)
    if (groupColumn) {
      // Group data by the specified column (e.g., 'insurance')
      const groupedData = records.reduce((acc, record) => {
        const groupKey = record[groupColumn];
        if (!acc[groupKey]) {
          acc[groupKey] = [];
        }
        acc[groupKey].push(record);
        return acc;
      }, {});

      // Get a unique, sorted list of dates for the x-axis labels
      labels = [...new Set(records.map(record => record[xColumn]))].sort();

      // Create a dataset for each group (e.g., each insurance company)
      datasets = Object.keys(groupedData).map(groupKey => {
        const groupRecords = groupedData[groupKey];
        const randomColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`;

        // Create a data array with nulls for missing dates to ensure lines align
        const data = labels.map(date => {
          const record = groupRecords.find(r => r[xColumn] === date);
          return record ? record[yColumn] : null;
        });

        return {
          label: groupKey,
          data: data,
          backgroundColor: randomColor.replace('1)', '0.5)'),
          borderColor: randomColor,
          borderWidth: 2,
          tension: 0.4,
          fill: false,
        };
      });

    } else { // Logic for a single-line chart (if no groupColumn is provided)
      labels = records.map(record => record[xColumn]);
      const randomColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`;

      datasets = [{
        label: yColumn,
        data: records.map(record => record[yColumn]),
        backgroundColor: randomColor.replace('1)', '0.5)'),
        borderColor: randomColor,
        borderWidth: 2,
        tension: 0.1,
        fill: false,
      }];
    }

    //Make the chart finally
    const chartData = {
      labels,
      datasets,
    };
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: groupColumn ? 'Percentage' : 'Values' },
          min:0,
          max: 1
  
        },
        x: {
          title: { display: true, text: xColumn }
        }
      },
      plugins: {
        legend: { display: true },
        tooltip: { mode: 'index', intersect: false }
      }
    };

    // Add specific time scale options for date data
    if (groupColumn) {
      chartOptions.scales.x = {
        type: 'time',
        time: {
            unit: 'month',
            tooltipFormat: 'MMM yyyy',
            displayFormats: {
                month: 'MMM yyyy'
            }
        },
        title: { display: true, text: 'Date' }
      };
    }

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: chartType,
      data: chartData,
      options: chartOptions,
    });
    }

    

    document.addEventListener('DOMContentLoaded', async () => {
      //Percent X Date per insurance
      renderSupabaseChart(
      'gapClosureChart',
       'closure_percentage', 
       'line', 
       'date', 
       'percentage', 
       'insurance'
      );
    
    });
    </script>
</body>
</html>
