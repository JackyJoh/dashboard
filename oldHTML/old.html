<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCH Dashboard</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for Noto Sans -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;600&display=swap" rel="stylesheet">
    <!-- Chart.js CDN for charting capabilities -->
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>

    <style>
        /* Custom font for body */
        body {
            font-family: 'Noto Sans', sans-serif; /* Changed font to Noto Sans, with sans-serif as fallback */
        }
        /* Ensure the body and html take full height to allow children to expand */
        html, body {
            height: 100%;
        }
        /* Custom styles for sidebar animation */
        #sidebar {
            /* Apply transitions to transform, width, and padding for smooth collapsing/expanding */
            transition: transform 0.3s ease-in-out, width 0.3s ease-in-out, padding 0.3s ease-in-out;
        }

        /* Custom styles for main content area margin transition when sidebar toggles on desktop */
        #main-content-area {
            transition: margin-left 0.3s ease-in-out;
        }

        /* Mobile specific styles (sidebar slides from left) */
        @media (max-width: 767px) { /* Tailwind's md breakpoint is 768px */
            #sidebar {
                transform: translateX(-100%); /* Start off-screen */
                position: fixed; /* Overlay on top of content */
                height: 100%; /* Take full height on mobile */
                z-index: 50; /* Ensure it's above other content */
                width: 75%; /* Adjust width for mobile sidebar */
                top: 0;
                left: 0;
            }
            body.sidebar-open #sidebar {
                transform: translateX(0); /* Slide in when open */
            }
            /* Show overlay when sidebar is open on mobile */
            body.sidebar-open #overlay {
                display: block;
            }
        }

        /* Desktop specific styles (sidebar width collapses/expands) */
        @media (min-width: 768px) {
            #sidebar {
                width: 16rem; /* Default open width for desktop (equivalent to w-64) */
                position: relative; /* Override fixed positioning from mobile */
                height: auto; /* Override height: 100% from mobile */
                z-index: auto; /* Override z-index from mobile */
                top: auto; /* Override top from mobile */
                left: auto; /* Override left from mobile */
            }
            /* When sidebar-open class is NOT present on desktop, collapse sidebar */
            body:not(.sidebar-open) #sidebar {
                width: 0;
                padding-left: 0;
                padding-right: 0;
                margin-right: 0;
                overflow: hidden; /* Hide content when collapsed */
            }
            /* When sidebar is open on desktop, apply margin to main content */
            body.sidebar-open #main-content-area {
                margin-left: 1rem; /* Equivalent to md:ml-4 */
            }
            /* When sidebar is closed on desktop, remove margin from main content */
            body:not(.sidebar-open) #main-content-area {
                margin-left: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 flex flex-col min-h-screen">

    <!-- New Header -->
    <header class="bg-black text-white p-4 flex items-center justify-between shadow-md h-16">
        <!-- Hamburger menu button now inside the header -->
        <button id="menu-button" class="p-2 rounded-md bg-indigo-600 text-white shadow-md">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>
        <p class="text-2xl font-semibold">NCH Dashboard</p>
        <div></div> <!-- Placeholder for any potential right-aligned header content -->
    </header>

    <!-- Overlay for mobile when sidebar is open - acts as a clickable backdrop -->
    <div id="overlay" class="hidden fixed inset-0 bg-black opacity-50 z-40 md:hidden"></div>

    <!-- Main layout container (flex for columns) - now directly below the header -->
    <!-- This div takes the remaining height after the header, accounting for its own padding -->
    <div class="w-full flex-grow flex p-3" style="height: calc(100vh - 4rem);">
        <!-- Left panel (Sidebar) -->
        <div id="sidebar" class="bg-gray-200 shadow-lg rounded-lg p-4 flex-shrink-0">
            <ul class="mt-4 space-y-2">
                <li><a href="index.html" class="block p-2 rounded-md hover:bg-gray-300">Dashboard</a></li>
                <li><a href="gaps.html" class="block p-2 rounded-md hover:bg-gray-300">Care Gap Closure</a></li>
                <li><a href="entry.html" class="block p-2 rounded-md hover:bg-gray-300">Patient Access Goals</a></li>
                <li><a href="demo.html" class="block p-2 rounded-md hover:bg-gray-300">Risk Score</a></li>
                <li><a href="entry.html" class="block p-2 rounded-md hover:bg-gray-300">Other</a></li>
            </ul>
        </div>

        <!-- Main content area -->
        <!-- This area takes full height of its parent and allows vertical scrolling if internal content overflows -->
        <div id="main-content-area" class="flex flex-col flex-grow h-full">

            <!-- 2x2 Grid Layout taking up remaining space -->
            <!-- Added 'grid-rows-2' to explicitly make two equal height rows -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 h-full grid-rows-2">
                <!-- Row 1 - Gap Closure Chart (now a canvas for Chart.js) -->
                <!-- Added overflow-y-auto to individual divs for internal scrolling if content overflows -->
                <div class="bg-white p-6 rounded-lg shadow-md flex items-center justify-center h-full overflow-y-auto">
                    <canvas id="gapClosureChart" class="w-full h-full"></canvas>
                </div>
                <div class="bg-green-200 p-6 rounded-lg shadow-md flex items-center justify-center h-full overflow-y-auto">
                    <p class="text-xl font-semibold text-green-800">Risk Score</p>
                </div>

                <!-- Row 2 -->
                <div class="bg-purple-200 p-6 rounded-lg shadow-md flex items-center justify-center h-full overflow-y-auto">
                    <!-- Canvas for the new TBD Metrics Line Chart -->
                    <canvas id="tbdMetricsChart" class="w-full h-full"></canvas>
                </div>
                <!-- This is the container for the two smaller boxes -->
                <div class="bg-red-200 p-2 rounded-lg shadow-md flex flex-col h-full overflow-y-auto">
                    <div class="grid grid-cols-2 md:grid-cols-2 gap-2 flex-grow h-full">
                        <div class="bg-red-100 p-2 rounded-lg shadow-md flex items-center justify-center h-full overflow-y-auto">
                            <!-- Canvas for the new Insurance Pie Chart -->
                            <canvas id="insurancePieChart" class="w-full h-full"></canvas>
                        </div>
                        <div class="bg-red-100 p-2 rounded-lg shadow-md flex items-center justify-center h-full overflow-y-auto">
                            <p class="text-xl font-semibold text-red-800">Other Metric</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const menuButton = document.getElementById('menu-button');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('overlay');
            const body = document.body;
            const mainContentArea = document.getElementById('main-content-area');

            function openSidebar() {
                body.classList.add('sidebar-open');
            }
            function closeSidebar() {
                body.classList.remove('sidebar-open');
            }
            if (window.innerWidth >= 768) {
                openSidebar(); // Sidebar open by default on desktop
            } else {
                closeSidebar(); // Sidebar closed by default on mobile
            }
            menuButton.addEventListener('click', function() {
                if (body.classList.contains('sidebar-open')) {
                    closeSidebar();
                } else {
                    openSidebar();
                }
            });
            overlay.addEventListener('click', closeSidebar);
            sidebar.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', closeSidebar);
            });
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 768) {
                    if (!body.classList.contains('sidebar-open')) {
                        openSidebar();
                    }
                } else {
                    closeSidebar();
                }
            });           
        });
    </script>


    <!-- Supabase and Chart.js Integration Script -->
     
    <script type="module">

    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const supabaseUrl = 'https://mzbnudzzilqcvwwwfrsw.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16Ym51ZHp6aWxxY3Z3d3dmcnN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyMzQzNTUsImV4cCI6MjA3MTgxMDM1NX0.FmEhkmCkiOI3C5sG0_N2eLpdA-YhUdjF6edtto-Tu_I';
    const supabase = createClient(supabaseUrl, supabaseKey);

    let chartInstance = null;
    

  async function renderSupabaseChart(canvasId, tableName, chartType, xColumn, yColumn, groupColumn = null) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) {
      console.error(`Canvas element with ID "${canvasId}" not found.`);
      return;
    }

    const ctx = canvas.getContext('2d');

    // Dynamically set the columns to fetch based on whether a groupColumn is provided
    const selectQuery = groupColumn ? `${xColumn}, ${yColumn}, ${groupColumn}` : `${xColumn}, ${yColumn}`;

    // Fetch data from the specified Supabase table
    const { data: records, error } = await supabase
      .from(tableName)
      .select(selectQuery)
      .order(xColumn, { ascending: true });

    //Error handling and no data case
    if (error) {
      console.error('Error fetching data:', error.message);
      return;
    }
    if (!records || records.length === 0) {
      console.warn('No data found for the specified table.');
      if (chartInstance) {
        chartInstance.destroy();
      }
      return;
    }

    let labels;
    let datasets;

    // Logic for a multi-line chart (if a groupColumn is provided)
    if (groupColumn) {
      // Group data by the specified column (e.g., 'insurance')
      const groupedData = records.reduce((acc, record) => {
        const groupKey = record[groupColumn];
        if (!acc[groupKey]) {
          acc[groupKey] = [];
        }
        acc[groupKey].push(record);
        return acc;
      }, {});

      // Get a unique, sorted list of dates for the x-axis labels
      labels = [...new Set(records.map(record => record[xColumn]))].sort();

      // Create a dataset for each group (e.g., each insurance company)
      datasets = Object.keys(groupedData).map(groupKey => {
        const groupRecords = groupedData[groupKey];
        const randomColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`;

        // Create a data array with nulls for missing dates to ensure lines align
        const data = labels.map(date => {
          const record = groupRecords.find(r => r[xColumn] === date);
          return record ? record[yColumn] : null;
        });

        return {
          label: groupKey,
          data: data,
          backgroundColor: randomColor.replace('1)', '0.5)'),
          borderColor: randomColor,
          borderWidth: 2,
          tension: 0.4,
          fill: false,
        };
      });

    } else { // Logic for a single-line chart (if no groupColumn is provided)
      labels = records.map(record => record[xColumn]);
      const randomColor = `rgba(${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, ${Math.floor(Math.random() * 256)}, 1)`;

      datasets = [{
        label: yColumn,
        data: records.map(record => record[yColumn]),
        backgroundColor: randomColor.replace('1)', '0.5)'),
        borderColor: randomColor,
        borderWidth: 2,
        tension: 0.1,
        fill: false,
      }];
    }

    //Make the chart finally
    const chartData = {
      labels,
      datasets,
    };
    const chartOptions = {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: groupColumn ? 'Percentage' : 'Values' },
          min:0,
          max: 1
  
        },
        x: {
          title: { display: true, text: xColumn }
        }
      },
      plugins: {
        legend: { display: true },
        tooltip: { mode: 'index', intersect: false }
      }
    };

    // Add specific time scale options for date data
    if (groupColumn) {
      chartOptions.scales.x = {
        type: 'time',
        time: {
            unit: 'month',
            tooltipFormat: 'MMM yyyy',
            displayFormats: {
                month: 'MMM yyyy'
            }
        },
        title: { display: true, text: 'Date' }
      };
    }

    if (chartInstance) {
      chartInstance.destroy();
    }

    chartInstance = new Chart(ctx, {
      type: chartType,
      data: chartData,
      options: chartOptions,
    });
    }

    

    document.addEventListener('DOMContentLoaded', async () => {
      //Percent X Date per insurance
      renderSupabaseChart(
      'gapClosureChart',
       'closure_percentage', 
       'line', 
       'date', 
       'percentage', 
       'insurance'
      );
      // await renderSupabaseChart(
      //   'myChart',
      //   'test_add',
      //   'line',
      //   'id',
      //   'nums'
      //   );

      // Attach event listener to the "Add Data" button
    
    });
    </script>
</body>
</html>
